#
# Usage:
# ansible-playbook -i inventory.tf.yml k8up-int-backup-app.yml -e "namespace=jellyfin"
#
# Namespace is required.
#
- name: Force backup of a specific K8up-registered application
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig_path: "{{ playbook_dir }}/../.kubeconfig-internal"
    namespace: ""
  tasks:
    - name: "{{ namespace }} - Validate namespace is provided }}"
      fail:
        msg: "namespace is required: -e 'namespace=jellyfin'"
      when: namespace == ""

    - name: "{{ namespace }} - Delete existing backup resources }}"
      shell: |
        kubectl get backups.k8up.io -n {{ namespace }} -o name --kubeconfig {{ kubeconfig_path }} | \
        xargs -r kubectl delete -n {{ namespace }} --kubeconfig {{ kubeconfig_path }}
      ignore_errors: true

    - name: "{{ namespace }} - Get schedule for backend config"
      command: kubectl get schedules.k8up.io -n {{ namespace }} -o json --kubeconfig {{ kubeconfig_path }}
      register: schedule_raw
      changed_when: false

    - name: "{{ namespace }} - Parse schedule"
      set_fact:
        schedule: "{{ schedule_raw.stdout | from_json | json_query('items') }}"

    - name: "{{ namespace }} - Fail if no schedule found"
      fail:
        msg: "No K8up Schedule found in namespace {{ namespace }}"
      when: schedule | length == 0


    - name: "{{ namespace }} - Get deployments"
      command: kubectl get deployments -n {{ namespace }} -o json --kubeconfig {{ kubeconfig_path }}
      register: deployments_raw
      changed_when: false

    - name: "{{ namespace }} - Parse deployments"
      set_fact:
        deployments: "{{ deployments_raw.stdout | from_json | json_query('items') }}"

    - name: "{{ namespace }} - Scale down deployments"
      command: kubectl scale deployment {{ item.metadata.name }} -n {{ namespace }} --replicas=0 --kubeconfig {{ kubeconfig_path }}
      loop: "{{ deployments }}"
      loop_control:
        label: "{{ item.metadata.name }}"

    - name: "{{ namespace }} - Create backup"
      command: kubectl apply -f - --kubeconfig {{ kubeconfig_path }}
      args:
        stdin: |
          apiVersion: k8up.io/v1
          kind: Backup
          metadata:
            name: manual-backup-{{ lookup('pipe', 'date +%s') }}
            namespace: {{ namespace }}
          spec:
            backend: {{ schedule[0].spec.backend | to_json }}
            podSecurityContext:
              fsGroup: 0
              runAsUser: 0

    - name: "{{ namespace }} - Wait for backup job to complete"
      shell: |
        kubectl get jobs -n {{ namespace }} -l k8up.io/type=backup -o json --kubeconfig {{ kubeconfig_path }} | \
        jq -e '.items[] | select(.status.succeeded == 1)' > /dev/null
      register: backup_job
      until: backup_job.rc == 0
      retries: 60
      delay: 10

    - name: "{{ namespace }} - Backup complete"
      debug:
        msg: "Backup completed successfully for {{ namespace }}"

    - name: "{{ namespace }} - Scale up deployments"
      command: kubectl scale deployment {{ item.metadata.name }} -n {{ namespace }} --replicas={{ item.spec.replicas | default(1) }} --kubeconfig {{ kubeconfig_path }}
      loop: "{{ deployments }}"
      loop_control:
        label: "{{ item.metadata.name }}"
