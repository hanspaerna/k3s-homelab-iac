apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: traefik-ext
resources:
  - namespace.yaml
  - gateway.yaml
  - gatewayclass.yaml
  - rbac.yaml
  - dashboard.yaml
  - pvc.yaml
  - middlewares.yaml
  - grants.yaml
  - secrets.yaml
  - ../../base/traefik/

patches:
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: traefik
        namespace: traefik
      spec:
        template:
          spec:
            containers:
              - name: traefik
                args:
                  - "--entryPoints.web.address=:80/tcp"
                  - "--entryPoints.websecure.address=:443/tcp"
                  - "--entryPoints.traefik.address=:8080/tcp"
                  - "--entryPoints.web.http.redirections.entrypoint.to=websecure"
                  - "--entryPoints.web.http.redirections.entrypoint.scheme=https" 
                  - "--entryPoints.web.http.redirections.entrypoint.permanent=true"
                  - "--api=true"
                  - "--api.dashboard=true"
                  - "--ping=true"
                  - "--global.sendAnonymousUsage=false"
                  - "--global.checkNewVersion=false"
                  - "--providers.kubernetescrd"
                  - "--providers.kubernetescrd.allowCrossNamespace=true"
                  - "--providers.kubernetesgateway=true"
                  - "--accesslog=true"
                  - "--accesslog.format=json"
                  - "--experimental.plugins.bouncer.modulename=github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
                  - "--experimental.plugins.bouncer.version=v1.4.6"
                volumeMounts:
                  - name: plugins-storage
                    mountPath: /plugins-storage
            initContainers:
              - name: fetch-crowdsec-key
                image: curlimages/curl:8.1.2
                env:
                  - name: REGISTRATION_TOKEN
                    valueFrom:
                      secretKeyRef:
                        name: crowdsec-lapi-secrets
                        key: registrationToken
                volumeMounts:
                  - name: tmp
                    mountPath: /tmp
                command:
                  - sh
                  - -c
                  - |
                    set -e
                    BNAME="traefik-bouncer"
                    API_HOST="http://crowdsec-service.crowdsec:8080"
                    EXISTING_KEY=$(curl -s "$API_HOST/v1/bouncers" \
                      -H "Registration-Token: $REGISTRATION_TOKEN" \
                      | sed -n 's/.*"name":"'"$BNAME"'","api_key":"\([^"]*\)".*/\1/p')

                    if [ -n "$EXISTING_KEY" ]; then
                      echo "Bouncer already exists, using existing key"
                      echo "$EXISTING_KEY" > /tmp/crowdsec.key
                    else
                      echo "Bouncer does not exist, registering new one..."
                      NEW_KEY=$(curl -s -X POST "$API_HOST/v1/bouncers/register" \
                        -H "Registration-Token: $REGISTRATION_TOKEN" \
                        -d "{\"name\":\"$BNAME\"}" \
                        | sed -n 's/.*"api_key":"\([^"]*\)".*/\1/p')

                      if [ -z "$NEW_KEY" ]; then
                        echo "Failed to obtain CrowdSec API key!" >&2
                        exit 1
                      fi

                      echo "$NEW_KEY" > /tmp/crowdsec.key
                    fi

                    chmod 600 /tmp/crowdsec.key
                    echo "CrowdSec API key successfully written to /tmp/crowdsec.key"
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: traefik
        namespace: traefik
      spec:
        template:
          spec:
            volumes:
            - $patch: replace
            - name: data
              persistentVolumeClaim:
                claimName: local-path-pvc
            - name: tmp
              emptyDir: {}
            - name: plugins-storage
              persistentVolumeClaim:
                claimName: plugins-storage-pvc

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: traefik
        namespace: traefik
      spec:
        template:
          spec:
            containers:
              - name: traefik
                ports:
                - $patch: replace
                - name: web
                  containerPort: 80
                  protocol: TCP
                - name: websecure
                  containerPort: 443
                  protocol: TCP
                - name: metrics
                  containerPort: 9100
                  protocol: TCP
                - name: traefik
                  containerPort: 8080
                  protocol: TCP

 
